using System;
using System.Collections.Generic;
using System.Linq;

namespace CourseManagementSingleFile
{
    public abstract class Course
    {
        public Guid Id { get; }
        public string Title { get; private set; }
        public Instructor Instructor { get; private set; }
        private readonly List<Student> _students = new List<Student>();
        public IEnumerable<Student> Students { get { return _students.AsReadOnly(); } }

        protected Course(string title)
        {
            if (title == null) throw new ArgumentNullException("title");
            Id = Guid.NewGuid();
            Title = title;
        }

        public void AssignInstructor(Instructor instr)
        {
            if (instr == null) throw new ArgumentNullException("instr");
            Instructor = instr;
        }

        public void RemoveInstructor() { Instructor = null; }

        public void AddStudent(Student s)
        {
            if (s == null) throw new ArgumentNullException("s");
            if (_students.Any(x => x.Id == s.Id)) throw new InvalidOperationException("Student already enrolled");
            _students.Add(s);
        }

        public void RemoveStudent(Guid studentId)
        {
            var s = _students.FirstOrDefault(x => x.Id == studentId);
            if (s == null) throw new KeyNotFoundException("Student not found");
            _students.Remove(s);
        }

        public void Rename(string t)
        {
            if (string.IsNullOrWhiteSpace(t)) throw new ArgumentException("Title cannot be empty");
            Title = t;
        }

        public override string ToString()
        {
            var instr = Instructor == null ? "(none)" : Instructor.Name;
            return $"[{GetType().Name}] {Title} (Id={Id}) - Instructor={instr}, Students={_students.Count}";
        }
    }

    public class OnlineCourse : Course
    {
        public string Platform { get; private set; }
        public Uri Url { get; private set; }

        public OnlineCourse(string title, string platform, Uri url = null) : base(title)
        {
            if (platform == null) throw new ArgumentNullException("platform");
            Platform = platform;
            Url = url;
        }

        public void SetUrl(string url)
        {
            Url = string.IsNullOrWhiteSpace(url) ? null : new Uri(url, UriKind.Absolute);
        }

        public void ChangePlatform(string p)
        {
            if (string.IsNullOrWhiteSpace(p)) throw new ArgumentException("Platform cannot be empty");
            Platform = p;
        }
    }

    public class OfflineCourse : Course
    {
        public string Location { get; private set; }
        public string Room { get; private set; }

        public OfflineCourse(string title, string location, string room) : base(title)
        {
            if (location == null) throw new ArgumentNullException("location");
            if (room == null) throw new ArgumentNullException("room");
            Location = location;
            Room = room;
        }

        public void ChangeRoom(string r)
        {
            if (string.IsNullOrWhiteSpace(r)) throw new ArgumentException("Room cannot be empty");
            Room = r;
        }

        public void ChangeLocation(string l)
        {
            if (string.IsNullOrWhiteSpace(l)) throw new ArgumentException("Location cannot be empty");
            Location = l;
        }
    }

    public class Student
    {
        public Guid Id { get; }
        public string Name { get; private set; }

        public Student(string name)
        {
            if (name == null) throw new ArgumentNullException("name");
            Id = Guid.NewGuid();
            Name = name;
        }

        public override string ToString() => $"Student: {Name} ({Id})";
    }

    public class Instructor
    {
        public Guid Id { get; }
        public string Name { get; private set; }        public Instructor(string name)
        {
            if (name == null) throw new ArgumentNullException("name");
            Id = Guid.NewGuid();
            Name = name;
        }

        public override string ToString() => $"Instructor: {Name} ({Id})";
    }

    public class CourseBuilder
    {
        private string _title;
        private bool _isOnline;
        private string _platform;
        private Uri _url;
        private string _location;
        private string _room;

        public static CourseBuilder Create() => new CourseBuilder();

        public CourseBuilder WithTitle(string t) { _title = t; return this; }
        public CourseBuilder AsOnline(string platform) { _isOnline = true; _platform = platform; return this; }
        public CourseBuilder WithUrl(string url) { _url = string.IsNullOrWhiteSpace(url) ? null : new Uri(url, UriKind.Absolute); return this; }
        public CourseBuilder AsOffline(string location, string room) { _isOnline = false; _location = location; _room = room; return this; }

        public Course Build()
        {
            if (string.IsNullOrWhiteSpace(_title)) throw new InvalidOperationException("Title required");
            if (_isOnline)
            {
                if (string.IsNullOrWhiteSpace(_platform)) throw new InvalidOperationException("Platform required for online course");
                return new OnlineCourse(_title, _platform, _url);
            }
            else
            {
                if (string.IsNullOrWhiteSpace(_location) || string.IsNullOrWhiteSpace(_room)) throw new InvalidOperationException("Location and room required for offline course");
                return new OfflineCourse(_title, _location, _room);
            }
        }
    }

    public interface ICourseRepository
    {
        void Add(Course c);
        void Remove(Guid id);
        Course GetById(Guid id);
        IEnumerable<Course> GetAll();
    }

    public class InMemoryCourseRepository : ICourseRepository
    {
        private readonly Dictionary<Guid, Course> _store = new Dictionary<Guid, Course>();

        public void Add(Course c)
        {
            if (c == null) throw new ArgumentNullException("c");
            if (_store.ContainsKey(c.Id)) throw new InvalidOperationException("Course already exists");
            _store[c.Id] = c;
        }

        public void Remove(Guid id)
        {
            if (!_store.Remove(id)) throw new KeyNotFoundException("Course not found");
        }

        public Course GetById(Guid id)
        {
            Course c;
            _store.TryGetValue(id, out c);
            return c;
        }

        public IEnumerable<Course> GetAll() => _store.Values;
    }

    public sealed class CourseManager
    {
        private readonly ICourseRepository _repo;

        public CourseManager() : this(new InMemoryCourseRepository()) { }
        public CourseManager(ICourseRepository repository)
        {
            _repo = repository ?? throw new ArgumentNullException("repository");
        }

        public void AddCourse(Course c) { _repo.Add(c ?? throw new ArgumentNullException("c")); }
        public void RemoveCourse(Guid id) { _repo.Remove(id); }
        public void AssignInstructor(Guid courseId, Instructor instr)
        {
            if (instr == null) throw new ArgumentNullException("instr");
            var c = _repo.GetById(courseId);
            if (c == null) throw new KeyNotFoundException("Course not found");
            c.AssignInstructor(instr);
        }

        public IEnumerable<Course> GetCoursesByInstructor(Guid instructorId)
        {
            return _repo.GetAll().Where(c => c.Instructor != null && c.Instructor.Id == instructorId);
        }

        public void EnrollStudent(Guid courseId, Student s)
        {
            if (s == null) throw new ArgumentNullException("s");
            var c = _repo.GetById(courseId);
            if (c == null) throw new KeyNotFoundException("Course not found");
            c.AddStudent(s);
        }        public void UnenrollStudent(Guid courseId, Guid studentId)
        {
            var c = _repo.GetById(courseId);
            if (c == null) throw new KeyNotFoundException("Course not found");
            c.RemoveStudent(studentId);
        }

        public Course GetCourse(Guid id) => _repo.GetById(id);
        public IEnumerable<Course> GetAllCourses() => _repo.GetAll();
    }

    class Program
    {
        static CourseManager mgr = new CourseManager();

        static void Main(string[] args)
        {
            SeedDemoData();
            while (true)
            {
                Console.WriteLine();
                Console.WriteLine("=== Course Management ===");
                Console.WriteLine("1. List all courses");
                Console.WriteLine("2. Add course");
                Console.WriteLine("3. Remove course");
                Console.WriteLine("4. Assign instructor to course");
                Console.WriteLine("5. Enroll student");
                Console.WriteLine("6. Unenroll student");
                Console.WriteLine("7. Show course details");
                Console.WriteLine("8. Show courses by instructor");
                Console.WriteLine("9. Rename course");
                Console.WriteLine("0. Exit");
                Console.Write("Select option: ");
                var opt = Console.ReadLine();

                try
                {
                    switch (opt)
                    {
                        case "1": ListAll(); break;
                        case "2": AddCourse(); break;
                        case "3": RemoveCourse(); break;
                        case "4": AssignInstructor(); break;
                        case "5": EnrollStudent(); break;
                        case "6": UnenrollStudent(); break;
                        case "7": ShowCourse(); break;
                        case "8": ShowByInstructor(); break;
                        case "9": RenameCourse(); break;
                        case "0": return;
                        default: Console.WriteLine("Unknown option"); break;
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine("Error: " + ex.GetType().Name + " - " + ex.Message);
                }
            }
        }

        static void SeedDemoData()
        {
            var c1 = CourseBuilder.Create().WithTitle("Intro to C#").AsOnline("ExamplePlatform").WithUrl("https://example.org/csharp").Build();
            var c2 = CourseBuilder.Create().WithTitle("Discrete Math").AsOffline("Main Campus", "201").Build();
            mgr.AddCourse(c1); mgr.AddCourse(c2);

            var instr = new Instructor("Dr. Ivanov");
            mgr.AssignInstructor(c1.Id, instr);
            mgr.AssignInstructor(c2.Id, instr);

            mgr.EnrollStudent(c1.Id, new Student("Olga"));
            mgr.EnrollStudent(c2.Id, new Student("Petr"));
        }

        static void ListAll()
        {
            Console.WriteLine();
            foreach (var c in mgr.GetAllCourses())
                Console.WriteLine(c.ToString());
        }        
        static void AddCourse()
        {
            Console.Write("Title: ");
            var title = Console.ReadLine();
            Console.Write("Type (1-online, 2-offline): ");
            var t = Console.ReadLine();
            if (t == "1")
            {
                Console.Write("Platform: ");
                var p = Console.ReadLine();
                Console.Write("Url (optional): ");
                var url = Console.ReadLine();
                var cb = CourseBuilder.Create().WithTitle(title).AsOnline(p);
                if (!string.IsNullOrWhiteSpace(url)) cb.WithUrl(url);
                var c = cb.Build();
                mgr.AddCourse(c);
                Console.WriteLine("Added: " + c.Id);
            }
            else
            {
                Console.Write("Location: ");
                var loc = Console.ReadLine();
                Console.Write("Room: ");
                var room = Console.ReadLine();
                var c = CourseBuilder.Create().WithTitle(title).AsOffline(loc, room).Build();
                mgr.AddCourse(c);
                Console.WriteLine("Added: " + c.Id);
            }
        }

        static void RemoveCourse()
        {
            var id = ReadGuid("Course Id to remove: ");
            mgr.RemoveCourse(id);
            Console.WriteLine("Removed.");
        }

        static void AssignInstructor()
        {
            var id = ReadGuid("Course Id: ");
            Console.Write("Instructor name: ");
            var name = Console.ReadLine();
            var ins = new Instructor(name);
            mgr.AssignInstructor(id, ins);
            Console.WriteLine("Assigned instructor " + ins.Id);
        }

        static void EnrollStudent()
        {
            var id = ReadGuid("Course Id: ");
            Console.Write("Student name: ");
            var name = Console.ReadLine();
            var s = new Student(name);
            mgr.EnrollStudent(id, s);
            Console.WriteLine("Enrolled student " + s.Id);
        }

        static void UnenrollStudent()
        {
            var id = ReadGuid("Course Id: ");
            var sid = ReadGuid("Student Id: ");
            mgr.UnenrollStudent(id, sid);
            Console.WriteLine("Unenrolled.");
        }

        static void ShowCourse()
        {
            var id = ReadGuid("Course Id: ");
            var c = mgr.GetCourse(id);
            if (c == null) { Console.WriteLine("Course not found"); return; }
            Console.WriteLine(c.ToString());
            Console.WriteLine("Students:");
            foreach (var s in c.Students) Console.WriteLine(" - " + s.Name + " (" + s.Id + ")");
            if (c is OnlineCourse on)
            {
                Console.WriteLine("Platform: " + on.Platform);
                Console.WriteLine("Url: " + (on.Url == null ? "(none)" : on.Url.ToString()));
            }
            else if (c is OfflineCourse of)
            {
                Console.WriteLine("Location: " + of.Location);
                Console.WriteLine("Room: " + of.Room);
            }
        }

        static void ShowByInstructor()
        {
            var id = ReadGuid("Instructor Id: ");
            var list = mgr.GetCoursesByInstructor(id).ToList();
            if (!list.Any()) Console.WriteLine("No courses found for this instructor.");
            foreach (var c in list) Console.WriteLine(" - " + c.Title + " (" + c.Id + ")");
        }

        static void RenameCourse()
        {
            var id = ReadGuid("Course Id: ");
            Console.Write("New title: ");
            var t = Console.ReadLine();
            var c = mgr.GetCourse(id);
            if (c == null) { Console.WriteLine("Course not found"); return; }
            c.Rename(t);
            Console.WriteLine("Renamed.");
        }        static Guid ReadGuid(string prompt)
        {
            while (true)
            {
                Console.Write(prompt);
                var s = Console.ReadLine();
                Guid g;
                if (Guid.TryParse(s, out g)) return g;
                Console.WriteLine("Invalid GUID, try again.");
            }
        }
    }
}
